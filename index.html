<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>グループ予定一覧</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    h1 {
      font-size: 1.5rem;
    }
    .controls {
      margin-bottom: 1rem;
    }
    label {
      margin-right: 1rem;
    }
    .time-block {
      margin-top: 1rem;
      border-top: 1px solid #ccc;
      padding-top: 0.5rem;
    }
    .time-title {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    .person-row {
      display: flex;
      align-items: center;
      padding: 2px 0;
    }
    .person-name {
      width: 140px;
      font-weight: bold;
    }
    .person-summary {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>グループ予定一覧</h1>

  <div class="controls">
    <label>グループアドレス：<input type="text" id="groupInput" placeholder="group@domain.com"></label>
    <label>日付を選択：<input type="date" id="datePicker"></label>
    <button id="reloadBtn">再読み込み</button>
  </div>

  <p id="loading">読み込み中...</p>
  <div id="scheduleList"></div>

  <script>
    const endpoint = "https://script.google.com/a/macros/sho-ei.net/s/AKfycbxkWcWduNlZcSMY0r31FkjdxZXjHaXwJDc_PraTXV_mm77P9a8-Epk2vrXRRqDrBFJhwA/exec";

    document.getElementById("reloadBtn").addEventListener("click", () => {
      const groupEmail = document.getElementById("groupInput").value.trim();
      const selectedDate = document.getElementById("datePicker").value;
      if (!groupEmail || !selectedDate) {
        document.getElementById("loading").textContent = "グループまたは日付が指定されていません。";
        return;
      }
      loadSchedule(groupEmail, selectedDate);
    });

    function formatDateWithWeekday(dateStr) {
      const date = new Date(dateStr);
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      return `${date.getMonth() + 1}月${date.getDate()}日(${weekdays[date.getDay()]})`;
    }

    function formatTimeRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);
      const pad = (n) => n.toString().padStart(2, '0');
      return `${pad(startDate.getHours())}:${pad(startDate.getMinutes())}〜${pad(endDate.getHours())}:${pad(endDate.getMinutes())}`;
    }

    function renderResult(data) {
      console.log("📦 GAS JSONP response:", data);
      const loading = document.getElementById("loading");
      if (data.error) {
        loading.textContent = `取得失敗: ${data.error}`;
        return;
      }

      const scheduleList = document.getElementById("scheduleList");
      scheduleList.innerHTML = "";

      const timeSlots = {};

      data.calendars.forEach(user => {
        user.events.forEach(ev => {
          const range = formatTimeRange(ev.start, ev.end);
          if (!timeSlots[range]) timeSlots[range] = [];
          timeSlots[range].push({
            name: user.name || user.email,
            summary: ev.summary,
            location: ev.location || ""
          });
        });
      });

      const dateStr = document.getElementById("datePicker").value;
      const title = document.createElement("h2");
      title.textContent = formatDateWithWeekday(dateStr);
      scheduleList.appendChild(title);

      if (Object.keys(timeSlots).length === 0) {
        scheduleList.innerHTML += '<p>予定なし</p>';
      } else {
        Object.keys(timeSlots).sort().forEach(range => {
          const block = document.createElement("div");
          block.className = "time-block";

          const timeTitle = document.createElement("div");
          timeTitle.className = "time-title";
          timeTitle.textContent = range;
          block.appendChild(timeTitle);

          timeSlots[range].forEach(ev => {
            const row = document.createElement("div");
            row.className = "person-row";

            const name = document.createElement("div");
            name.className = "person-name";
            name.textContent = ev.name;

            const summary = document.createElement("div");
            summary.className = "person-summary";
            summary.textContent = `${ev.summary}${ev.location ? " @ " + ev.location : ""}`;

            row.appendChild(name);
            row.appendChild(summary);
            block.appendChild(row);
          });

          scheduleList.appendChild(block);
        });
      }

      loading.style.display = "none";
    }

    function loadSchedule(group, date) {
      document.getElementById("loading").style.display = "block";
      document.getElementById("loading").textContent = "読み込み中...";
      document.getElementById("scheduleList").innerHTML = "";

      const url = `${endpoint}?group=${encodeURIComponent(group)}&date=${encodeURIComponent(date)}&callback=renderResult`;
      console.log("🔗 JSONP URL:", url);

      const oldScript = document.getElementById("jsonpScript");
      if (oldScript) oldScript.remove();

      const script = document.createElement("script");
      script.src = url;
      script.id = "jsonpScript";
      document.body.appendChild(script);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("datePicker").value = today;

      const params = new URLSearchParams(window.location.search);
      const groupEmail = params.get("group") || "";
      if (groupEmail) {
        document.getElementById("groupInput").value = groupEmail;
        loadSchedule(groupEmail, today);
      } else {
        document.getElementById("loading").textContent = "グループアドレスを入力してください。";
      }
    });
  </script>
</body>
</html>
