<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šä¸€è¦§</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    h1 {
      font-size: 1.5rem;
    }
    h3 {
      margin-top: 1rem;
      font-weight: bold;
    }
    ul {
      padding-left: 1.2rem;
    }
    .controls {
      margin-bottom: 1rem;
    }
    label {
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <h1>ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šä¸€è¦§</h1>

  <div class="controls">
    <label>ã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š<input type="text" id="groupInput" placeholder="group@domain.com"></label>
    <label>æ—¥ä»˜ã‚’é¸æŠï¼š<input type="date" id="datePicker"></label>
    <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
  </div>

  <p id="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
  <div id="scheduleList"></div>

  <script>
    const endpoint = "https://script.google.com/a/macros/sho-ei.net/s/AKfycbxkWcWduNlZcSMY0r31FkjdxZXjHaXwJDc_PraTXV_mm77P9a8-Epk2vrXRRqDrBFJhwA/exec";

    document.getElementById("reloadBtn").addEventListener("click", () => {
      const groupEmail = document.getElementById("groupInput").value.trim();
      const selectedDate = document.getElementById("datePicker").value;
      if (!groupEmail || !selectedDate) {
        document.getElementById("loading").textContent = "ã‚°ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯æ—¥ä»˜ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        return;
      }
      loadSchedule(groupEmail, selectedDate);
    });

    function loadSchedule(group, date) {
      document.getElementById("loading").style.display = "block";
      document.getElementById("loading").textContent = "èª­ã¿è¾¼ã¿ä¸­...";
      document.getElementById("scheduleList").innerHTML = "";

      const url = `${endpoint}?group=${encodeURIComponent(group)}&date=${encodeURIComponent(date)}&callback=renderResult`;
      console.log("ğŸ”— JSONP URL:", url);

      const oldScript = document.getElementById("jsonpScript");
      if (oldScript) oldScript.remove();

      const script = document.createElement("script");
      script.src = url;
      script.id = "jsonpScript";
      document.body.appendChild(script);
    }

    function renderResult(data) {
      console.log("ğŸ“¦ GAS JSONP response:", data);
      const loading = document.getElementById("loading");
      if (data.error) {
        loading.textContent = `å–å¾—å¤±æ•—: ${data.error}`;
        return;
      }

      const scheduleList = document.getElementById("scheduleList");
      scheduleList.innerHTML = "";

      data.calendars.forEach(user => {
        const div = document.createElement("div");
        div.innerHTML = `<h3>${user.email}</h3>`;
        if (user.events.length === 0) {
          div.innerHTML += "<p>äºˆå®šãªã—</p>";
        } else {
          const ul = document.createElement("ul");
          user.events.forEach(ev => {
            ul.innerHTML += `<li>${ev.start}ã€œ${ev.end}ï¼š${ev.summary}${ev.location ? " @ " + ev.location : ""}</li>`;
          });
          div.appendChild(ul);
        }
        scheduleList.appendChild(div);
      });

      loading.style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("datePicker").value = today;

      const params = new URLSearchParams(window.location.search);
      const groupEmail = params.get("group") || "";
      if (groupEmail) {
        document.getElementById("groupInput").value = groupEmail;
        loadSchedule(groupEmail, today);
      } else {
        document.getElementById("loading").textContent = "ã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }
    });
  </script>
</body>
</html>
